name: build by deepseek

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 */2 * *' # æ¯2å¤©è¿è¡Œä¸€æ¬¡

env:
  IMMORTALWRT_REPO: https://github.com/immortalwrt/immortalwrt
  IMMORTALWRT_BRANCH: openwrt-24.10

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      config_files: ${{ steps.find-configs.outputs.config_files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find config files
        id: find-configs
        run: |
          # æŸ¥æ‰¾æ‰€æœ‰.configæ–‡ä»¶å¹¶è½¬æ¢ä¸ºJSONæ•°ç»„æ ¼å¼
          config_files=$(find . -name "*.config" -type f | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "config_files=${config_files}" >> $GITHUB_OUTPUT

  build:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config_file: ${{ fromJSON(needs.setup.outputs.config_files) }}
    continue-on-error: true # ä¸€ä¸ªé…ç½®å¤±è´¥ä¸å½±å“å…¶ä»–é…ç½®
    name: build_${{ matrix.config_file }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse config filename
        id: parse-config
        run: |
          filename=$(basename "${{ matrix.config_file }}" .config)
          IFS=';' read -ra parts <<< "$filename"
          if [ ${#parts[@]} -ge 2 ]; then
            echo "config_owner=${parts[0]}" >> $GITHUB_OUTPUT
            echo "config_type=${parts[1]}" >> $GITHUB_OUTPUT
            echo "job_name=${parts[1]}_for_${parts[0]}" >> $GITHUB_OUTPUT
          else
            echo "Invalid config file name format: $filename"
            echo "Expected format: owner;type.config"
            exit 1
          fi

      - name: Set up build environment
        run: |
          sudo bash -c 'bash <(curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh)'

      - name: Clone ImmortalWrt
        run: |
          git clone $IMMORTALWRT_REPO --branch=$IMMORTALWRT_BRANCH --depth=1 immortalwrt
          cd immortalwrt

      - name: Copy config file
        run: |
          cp "${{ matrix.config_file }}" immortalwrt/.config

      - name: Check and copy diy.sh if exists
        run: |
          if [ -f "diy.sh" ]; then
            echo "Copying diy.sh to build directory"
            cp diy.sh immortalwrt/
          else
            echo "diy.sh not found, skipping"
          fi

      - name: Setup feeds
        working-directory: ./immortalwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Run diy.sh if exists
        working-directory: ./immortalwrt
        run: |
          if [ -f "diy.sh" ]; then
            echo "Running diy.sh"
            chmod +x diy.sh
            ./diy.sh
          else
            echo "diy.sh not found, skipping"
          fi

      #- name: Handle oldconfig
      #  working-directory: ./immortalwrt
      #  run: |
      #    make oldconfig

      - name: Build firmware
        working-directory: ./immortalwrt
        run: |
          make -j$(nproc) V=s

      - name: Collect firmware artifacts
        working-directory: ./immortalwrt/bin/targets
        run: |
          mkdir -p artifacts
          # æŸ¥æ‰¾æ‰€æœ‰å›ºä»¶æ–‡ä»¶
          find . -name "*.bin" -o -name "*.img" -o -name "*.gz" -o -name "*.zip" -o -name "*.tar" | while read file; do
            cp "$file" artifacts/
          done
          
          # è®°å½•æ–‡ä»¶åˆ—è¡¨
          ls -la artifacts/ > file_list.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.parse-config.outputs.job_name }}
          path: immortalwrt/bin/targets/artifacts/*

  release:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Generate firmware list
        id: generate-list
        run: |
          FIRMWARE_LIST=""
          for artifact_dir in ./artifacts/*/; do
            if [ -d "$artifact_dir" ]; then
              dir_name=$(basename "$artifact_dir")
              # è§£æç›®å½•åæ ¼å¼ä¸ºtype_for_owner
              IFS='_' read -ra parts <<< "$dir_name"
              type="${parts[0]}"
              owner="${parts[2]}"
              
              for file in "$artifact_dir"/*; do
                if [ -f "$file" ]; then
                  filename=$(basename "$file")
                  FIRMWARE_LIST+="- **$owner** / $type / \`$filename\`\n"
                fi
              done
            fi
          done
          
          if [ -z "$FIRMWARE_LIST" ]; then
            FIRMWARE_LIST="æœ¬æ¬¡ç¼–è¯‘æœªç”Ÿæˆä»»ä½•å›ºä»¶æ–‡ä»¶"
          fi
          
          echo "firmware_list<<EOF" >> $GITHUB_OUTPUT
          echo "$FIRMWARE_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get current date
        id: date
        run: |
          echo "current_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "current_datetime=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "å›ºä»¶ç¼–è¯‘äº${{ steps.date.outputs.current_datetime }}"
          name: "å›ºä»¶ç¼–è¯‘äº${{ steps.date.outputs.current_datetime }}"
          body: |
            ![ç¼–è¯‘æ—¥æœŸ](https://img.shields.io/badge/ç¼–è¯‘æ—¥æœŸ-${{ steps.date.outputs.current_date }}-blue.svg)

            ## ğŸ“¦ ç¼–è¯‘å›ºä»¶æ¸…å•
            ${{ steps.generate-list.outputs.firmware_list }}

            ## ğŸ—ï¸ ç¼–è¯‘ä¿¡æ¯
            - **ä»“åº“**: ${{ env.IMMORTALWRT_REPO }}
            - **åˆ†æ”¯**: ${{ env.IMMORTALWRT_BRANCH }}
            - **ç¼–è¯‘æ—¶é—´**: ${{ steps.date.outputs.current_datetime }}

            ## âš™ï¸ è‡ªåŠ¨ç¼–è¯‘è¯´æ˜
            æœ¬é¡¹ç›®æ¯éš”2å¤©ç”¨æœ€æ–°æºç è¿›è¡Œè‡ªåŠ¨ç¼–è¯‘ï¼Œç¡®ä¿å›ºä»¶å§‹ç»ˆåŸºäºæœ€æ–°çš„ä»£ç å’Œå®‰å…¨æ€§æ›´æ–°ã€‚

            ğŸ“Œ **æ‰‹åŠ¨è§¦å‘æ–¹å¼**: åœ¨GitHub Actionsé¡µé¢é€‰æ‹©build workflowï¼Œç‚¹å‡»"Run workflow"æŒ‰é’®ã€‚

            > ğŸ”„ å®šæ—¶ç¼–è¯‘: æ¯2å¤©è‡ªåŠ¨è¿è¡Œä¸€æ¬¡
            > ğŸš€ æ‰‹åŠ¨è§¦å‘: éšæ—¶å¯ä»¥æ‰‹åŠ¨å¯åŠ¨ç¼–è¯‘
            > ğŸ“Š ç¼–è¯‘çŠ¶æ€: ç‹¬ç«‹ç¼–è¯‘æ¯ä¸ªé…ç½®ï¼Œå¤±è´¥äº’ä¸å½±å“
          files: ./artifacts/**/*
          token: ${{ secrets.GH_PAT }}

      - name: Clean up old releases
        uses: dev-drprasad/delete-older-releases@v0.2.0
        with:
          keep_latest: 5
          delete_tag_pattern: "å›ºä»¶ç¼–è¯‘äº*"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: Show release info
        run: |
          echo "Release created successfully!"
          echo "Tag: å›ºä»¶ç¼–è¯‘äº${{ steps.date.outputs.current_datetime }}"
          echo "Firmware files uploaded:"
          find ./artifacts -type f -name "*" | while read file; do
            echo "  - $(basename "$file")"
          done
