name: build by grok

on:
  schedule:
    - cron: '0 0 */2 * *'  # Every 2 days at 00:00 UTC
  workflow_dispatch:

permissions:
  contents: write

env:
  IMMORTALWRT_REPO: https://github.com/immortalwrt/immortalwrt
  IMMORTALWRT_BRANCH: openwrt-24.10

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate matrix
        id: generate-matrix
        run: |
          configs=$(ls *.config 2>/dev/null || true)
          matrix_json='{"include": []}'
          if [ -n "$configs" ]; then
            matrix_include=()
            for config in $configs; do
              owner_type="${config%.config}"
              owner="${owner_type%%;*}"
              type="${owner_type#*;}"
              matrix_include+=("{\"owner\": \"$owner\", \"type\": \"$type\", \"job_name\": \"${type}_for_${owner}\"}")
            done
            matrix_include_str=$(IFS=,; echo "${matrix_include[*]}")
            matrix_json="{\"include\": [$matrix_include_str]}"
          fi
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT

  build:
    needs: discover
    if: ${{ needs.discover.outputs.matrix != '' }}
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}
      fail-fast: false
    continue-on-error: true # ä¸€ä¸ªé…ç½®å¤±è´¥ä¸å½±å“å…¶ä»–é…ç½®
    name: ${{ matrix.type }}_for_${{ matrix.owner }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show system
        run: |
          echo -e "Total CPU cores\t: $(nproc)"
          cat /proc/cpuinfo | grep 'model name'
          free -h
          df -Th
          cpu_name=$(cat /proc/cpuinfo | grep "model name" | head -n 1 | awk -F: '{print $2}' | sed 's/^[ \t]*//')
          echo "CPUå‹å·ä¸º${cpu_name}"
          
      - name: Setup build environment
        run: |
          sudo bash -c 'bash <(curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "Asia/Shanghai"
          # sudo rm -f /swapfile /mnt/swapfile
          sudo docker image prune -a -f
          sudo systemctl stop docker
          sudo snap set system refresh.retain=2
          sudo apt-get -y purge firefox clang* ghc* google* llvm* mono* mongo* mysql* php*
          sudo apt-get -y autoremove --purge
          sudo apt-get clean
          sudo rm -rf /etc/mysql /etc/php /usr/lib/jvm /usr/libexec/docker /usr/local /usr/src/* /var/lib/docker /var/lib/gems /var/lib/mysql /var/lib/snapd /etc/skel /opt/{microsoft,az,hostedtoolcache,cni,mssql-tools,pipx} /usr/share/{az*,dotnet,swift,miniconda,gradle*,java,kotlinc,ri,sbt} /root/{.sbt,.local,.npm}
          # sudo sed -i '/NVM_DIR/d;/skel/d' /root/{.bashrc,.profile}
          rm -rf ~/{.cargo,.dotnet,.rustup}
          

      - name: Clone ImmortalWRT
        run: |
          df -Th
          git clone --depth 1 -b $IMMORTALWRT_BRANCH $IMMORTALWRT_REPO openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Run diy.sh if exists
        run: |
          if [ -f diy.sh ]; then
            cp diy.sh openwrt/diy.sh
            cd openwrt
            bash diy.sh
          fi

      - name: Prepare config
        run: |
          cp "${{ matrix.owner }};${{ matrix.type }}.config" openwrt/.config
          cd openwrt
          yes "" | make oldconfig
          echo "ä»¥ä¸‹æ˜¯æœ€ç»ˆç”Ÿæ•ˆçš„é…ç½®ä¸æ‚¨åŸå§‹é…ç½®çš„å·®å¼‚ï¼ˆé¢„æœŸä¸åº”æœ‰é‡å¤§å·®å¼‚ï¼‰:"
          diff -u "../${{ matrix.owner }};${{ matrix.type }}.config" .config || true  # `|| true` é˜²æ­¢diffæœ‰å·®å¼‚æ—¶å¯¼è‡´å·¥ä½œæµå¤±è´¥
          

      - name: Download packages
        run: |
          cd openwrt
          make -j$(nproc) download V=s

      - name: Build firmware
        run: |
          cd openwrt
          make -j$(nproc) V=s

      - name: Collect firmware artifacts
        working-directory: ./openwrt/bin/targets
        run: |
          mkdir -p artifacts
          # æŸ¥æ‰¾æ‰€æœ‰å›ºä»¶æ–‡ä»¶
          find . -name "*.bin" -o -name "*.img" -o -name "*.gz" -o -name "*.zip" -o -name "*.tar" | while read file; do
            cp "$file" artifacts/
          done
          
          # è®°å½•æ–‡ä»¶åˆ—è¡¨
          ls -la artifacts/ > file_list.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.type }}_for_${{ matrix.owner }}
          path: openwrt/bin/targets/artifacts/*

  release:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Generate firmware list
        id: generate-list
        run: |
          FIRMWARE_LIST=""
          for artifact_dir in ./artifacts/*/; do
            if [ -d "$artifact_dir" ]; then
              dir_name=$(basename "$artifact_dir")
              # è§£æç›®å½•åæ ¼å¼ä¸ºtype_for_owner
              IFS='_' read -ra parts <<< "$dir_name"
              type="${parts[0]}"
              owner="${parts[2]}"
              
              for file in "$artifact_dir"/*; do
                if [ -f "$file" ]; then
                  filename=$(basename "$file")
                  FIRMWARE_LIST+="- **$owner** / $type / \`$filename\`\n"
                fi
              done
            fi
          done
          
          if [ -z "$FIRMWARE_LIST" ]; then
            FIRMWARE_LIST="æœ¬æ¬¡ç¼–è¯‘æœªç”Ÿæˆä»»ä½•å›ºä»¶æ–‡ä»¶"
          fi
          
          echo "firmware_list<<EOF" >> $GITHUB_OUTPUT
          echo "$FIRMWARE_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get current date
        id: date
        run: |
          echo "current_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "current_datetime=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "å›ºä»¶ç¼–è¯‘äº${{ steps.date.outputs.current_datetime }}"
          name: "å›ºä»¶ç¼–è¯‘äº${{ steps.date.outputs.current_datetime }}"
          body: |
            ![ç¼–è¯‘æ—¥æœŸ](https://img.shields.io/badge/ç¼–è¯‘æ—¥æœŸ-${{ steps.date.outputs.current_date }}-blue.svg)

            ## ğŸ“¦ ç¼–è¯‘å›ºä»¶æ¸…å•
            ${{ steps.generate-list.outputs.firmware_list }}

            ## ğŸ—ï¸ ç¼–è¯‘ä¿¡æ¯
            - **ä»“åº“**: ${{ env.IMMORTALWRT_REPO }}
            - **åˆ†æ”¯**: ${{ env.IMMORTALWRT_BRANCH }}
            - **ç¼–è¯‘æ—¶é—´**: ${{ steps.date.outputs.current_datetime }}

            ## âš™ï¸ è‡ªåŠ¨ç¼–è¯‘è¯´æ˜
            æœ¬é¡¹ç›®æ¯éš”2å¤©ç”¨æœ€æ–°æºç è¿›è¡Œè‡ªåŠ¨ç¼–è¯‘ï¼Œç¡®ä¿å›ºä»¶å§‹ç»ˆåŸºäºæœ€æ–°çš„ä»£ç å’Œå®‰å…¨æ€§æ›´æ–°ã€‚

            ğŸ“Œ **æ‰‹åŠ¨è§¦å‘æ–¹å¼**: åœ¨GitHub Actionsé¡µé¢é€‰æ‹©build workflowï¼Œç‚¹å‡»"Run workflow"æŒ‰é’®ã€‚

            > ğŸ”„ å®šæ—¶ç¼–è¯‘: æ¯2å¤©è‡ªåŠ¨è¿è¡Œä¸€æ¬¡
            > ğŸš€ æ‰‹åŠ¨è§¦å‘: éšæ—¶å¯ä»¥æ‰‹åŠ¨å¯åŠ¨ç¼–è¯‘
            > ğŸ“Š ç¼–è¯‘çŠ¶æ€: ç‹¬ç«‹ç¼–è¯‘æ¯ä¸ªé…ç½®ï¼Œå¤±è´¥äº’ä¸å½±å“
          files: ./artifacts/**/*
          token: ${{ secrets.GH_PAT }}

      - name: Clean up old releases
        uses: dev-drprasad/delete-older-releases@v0.2.0
        with:
          keep_latest: 5
          delete_tag_pattern: "å›ºä»¶ç¼–è¯‘äº*"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: Show release info
        run: |
          echo "Release created successfully!"
          echo "Tag: å›ºä»¶ç¼–è¯‘äº${{ steps.date.outputs.current_datetime }}"
          echo "Firmware files uploaded:"
          find ./artifacts -type f -name "*" | while read file; do
            echo "  - $(basename "$file")"
          done
